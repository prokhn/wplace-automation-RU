<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç–∞ - WPlace Bot</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            padding: 20px;
            min-height: 600px;
        }

        .sidebar {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
        }

        .sidebar h3 {
            margin: 0 0 15px 0;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
        }

        .canvas-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #fafafa;
            border-radius: 8px;
            padding: 20px;
        }

        .canvas-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-btn.primary {
            background: #667eea;
            color: white;
        }

        .control-btn.primary:hover {
            background: #5a67d8;
        }

        .control-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .control-btn.secondary:hover {
            background: #cbd5e0;
        }

        .control-btn.danger {
            background: #f56565;
            color: white;
        }

        .control-btn.danger:hover {
            background: #e53e3e;
        }

        #pixelCanvas {
            border: 2px solid #ddd;
            cursor: crosshair;
            image-rendering: pixelated;
            background: 
                repeating-linear-gradient(
                    0deg,
                    rgba(0,0,0,0.03),
                    rgba(0,0,0,0.03) 1px,
                    transparent 1px,
                    transparent 20px
                ),
                repeating-linear-gradient(
                    90deg,
                    rgba(0,0,0,0.03),
                    rgba(0,0,0,0.03) 1px,
                    transparent 1px,
                    transparent 20px
                );
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }

        .color-swatch {
            width: 35px;
            height: 35px;
            border-radius: 5px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .color-swatch:hover {
            transform: scale(1.1);
        }

        .color-swatch.selected {
            border-color: #333;
            transform: scale(1.15);
        }

        .size-controls {
            margin-bottom: 15px;
        }

        .size-controls label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .size-controls input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .tools {
            margin-bottom: 15px;
        }

        .tool-btn {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: left;
            background: #e2e8f0;
            transition: all 0.3s;
        }

        .tool-btn:hover, .tool-btn.active {
            background: #667eea;
            color: white;
        }

        .export-section {
            margin-top: 20px;
        }

        .export-tabs {
            display: flex;
            margin-bottom: 10px;
        }

        .export-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: #e2e8f0;
            cursor: pointer;
            font-size: 12px;
        }

        .export-tab.active {
            background: #667eea;
            color: white;
        }

        .export-content {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .copy-btn {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: #38a169;
        }

        .stats {
            background: #e6fffa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .stats strong {
            color: #2d3748;
        }

        .wplace-settings {
            margin-bottom: 15px;
        }

        .wplace-settings input {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .grid-overlay {
            position: absolute;
            pointer-events: none;
            border: 1px solid rgba(0,0,0,0.1);
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .sidebar {
                order: 2;
            }
            
            .canvas-container {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® –†–µ–¥–∞–∫—Ç–æ—Ä –ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç–∞ - WPlace Bot</h1>
            <p>–†–∏—Å—É–π—Ç–µ –ø—Ä—è–º–æ –Ω–∞ —Ö–æ–ª—Å—Ç–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç!</p>
        </div>

        <div class="main-content">
            <!-- –õ–µ–≤–∞—è –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã -->
            <div class="sidebar">
                <h3>üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h3>
                
                <div class="tools">
                    <button class="tool-btn active" data-tool="brush">üñåÔ∏è –ö–∏—Å—Ç—å</button>
                    <button class="tool-btn" data-tool="eraser">üßΩ –õ–∞—Å—Ç–∏–∫</button>
                    <button class="tool-btn" data-tool="bucket">ü™£ –ó–∞–ª–∏–≤–∫–∞</button>
                    <button class="tool-btn" data-tool="picker">üéØ –ü–∏–ø–µ—Ç–∫–∞</button>
                    <button class="tool-btn" data-tool="line">üìè –õ–∏–Ω–∏—è</button>
                    <button class="tool-btn" data-tool="rectangle">‚¨ú –ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</button>
                </div>

                <h3>üé® –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤</h3>
                <div class="color-palette" id="colorPalette"></div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block Regulation: block; margin-bottom: 5px; font-weight: bold;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ü–≤–µ—Ç:</label>
                    <input type="color" id="customColor" value="#000000" style="width: 100%; height: 40px; border: none; border-radius: 5px;">
                </div>

                <h3>üìê –†–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞</h3>
                <div class="size-controls">
                    <label>–®–∏—Ä–∏–Ω–∞:</label>
                    <input type="number" id="canvasWidth" value="20" min="5" max="100">
                    
                    <label>–í—ã—Å–æ—Ç–∞:</label>
                    <input type="number" id="canvasHeight" value="20" min="5" max="100">
                    
                    <button class="control-btn primary" onclick="resizeCanvas()">üìè –ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</button>
                </div>
            </div>

            <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ö–æ–ª—Å—Ç -->
            <div class="canvas-container">
                <div class="canvas-controls">
                    <button class="control-btn secondary" onclick="clearCanvas()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    <button class="control-btn secondary" onclick="undoAction()">‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å</button>
                    <button class="control-btn secondary" onclick="redoAction()">‚Ü∑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
                    <button class="control-btn primary" onclick="generateScript()">üìú –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç</button>
                    <label class="control-btn secondary" style="cursor: pointer;">
                        üìÅ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                        <input type="file" id="importImage" accept="image/*" style="display: none;">
                    </label>
                    <button class="control-btn secondary" onclick="exportPNG()">üíæ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å PNG</button>
                </div>
                
                <div style="position: relative;">
                    <canvas id="pixelCanvas" width="400" height="400"></canvas>
                </div>
                
                <div style="margin-top: 15px; text-align: center;">
                    <label style="margin-right: 15px;">
                        <input type="checkbox" id="showGrid" checked> –ü–æ–∫–∞–∑–∞—Ç—å —Å–µ—Ç–∫—É
                    </label>
                    <label>
                        –ú–∞—Å—à—Ç–∞–±: <input type="range" id="zoomSlider" min="1" max="5" value="2" style="width: 100px;">
                        <span id="zoomValue">2x</span>
                    </label>
                </div>
            </div>

            <!-- –ü—Ä–∞–≤–∞—è –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —ç–∫—Å–ø–æ—Ä—Ç -->
            <div class="sidebar">
                <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WPlace</h3>
                <div class="wplace-settings">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è X:</label>
                    <input type="number" id="startX" value="100" min="0">
                    
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ù–∞—á–∞–ª—å–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è Y:</label>
                    <input type="number" id="startY" value="100" min="0">
                    
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–∏–∫—Å–µ–ª—è–º–∏ (–º—Å):</label>
                    <input type="number" id="pixelDelay" value="1000" min="100" max="10000">
                    
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">–ò–º—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label>
                    <input type="text" id="imageName" value="–º–æ–π_—Ä–∏—Å—É–Ω–æ–∫" placeholder="–∏–º—è_–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                </div>

                <div class="stats" id="drawingStats">
                    <strong>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong><br>
                    –ü–∏–∫—Å–µ–ª–µ–π: <span id="pixelCount">0</span><br>
                    –¶–≤–µ—Ç–æ–≤: <span id="colorCount">0</span><br>
                    –†–∞–∑–º–µ—Ä: <span id="canvasSize">20x20</span><br>
                    –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: <span id="estimatedTime">0—Å</span>
                </div>

                <h3>üìã –≠–∫—Å–ø–æ—Ä—Ç —Å–∫—Ä–∏–ø—Ç–∞</h3>
                <div class="export-tabs">
                    <button class="export-tab active" onclick="showExportTab('script')">–°–∫—Ä–∏–ø—Ç</button>
                    <button class="export-tab" onclick="showExportTab('data')">–î–∞–Ω–Ω—ã–µ</button>
                    <button class="export-tab" onclick="showExportTab('function')">–§—É–Ω–∫—Ü–∏—è</button>
                </div>
                
                <div class="export-content" id="exportOutput">
                    –ù–∞—Ä–∏—Å—É–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –Ω–∞ —Ö–æ–ª—Å—Ç–µ, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç!
                </div>
                
                <button class="copy-btn" onclick="copyToClipboard()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let canvas = document.getElementById('pixelCanvas');
        let ctx = canvas.getContext('2d');
        let currentTool = 'brush';
        let currentColor = '#000000';
        let isDrawing = false;
        let pixels = new Map(); // –•—Ä–∞–Ω–∏—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–µ –ø–∏–∫—Å–µ–ª–∏
        let undoStack = [];
        let redoStack = [];
        let gridSize = 20;
        let zoom = 2;
        let canvasPixelWidth = 20;
        let canvasPixelHeight = 20;
        let exportMode = 'script';

        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤
        const defaultPalette = [
            '#FFFFFF', '#E4E4E4', '#888888', '#222222', '#000000',
            '#FFA7D1', '#E50000', '#E59500', '#A06A42', '#E5D900',
            '#94E044', '#02BE01', '#00D3DD', '#0083C7', '#0000EA',
            '#CF6EE4', '#820080', '#FF0000', '#00FF00', '#0000FF',
            '#FFFF00', '#FF00FF', '#00FFFF', '#FFA500', '#800080',
            '#008000', '#000080', '#808080', '#FF6B6B', '#4ECDC4'
        ];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            setupCanvas();
            setupColorPalette();
            setupEventListeners();
            updateStats();
        }

        function setupCanvas() {
            resizeCanvasDisplay();
            ctx.imageSmoothingEnabled = false;
            drawGrid();
        }

        function setupColorPalette() {
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = '';
            
            defaultPalette.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.onclick = () => selectColor(color);
                palette.appendChild(swatch);
            });
            
            // –ü–æ–¥–æ–∂–¥–∞—Ç—å, –ø–æ–∫–∞ DOM –æ–±–Ω–æ–≤–∏—Ç—Å—è, –ø–µ—Ä–µ–¥ –≤—ã–±–æ—Ä–æ–º —Ü–≤–µ—Ç–∞
            setTimeout(() => {
                selectColor('#000000');
            }, 100);
        }

        function setupEventListeners() {
            // –°–æ–±—ã—Ç–∏—è —Ö–æ–ª—Å—Ç–∞
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);
            canvas.addEventListener('contextmenu', e => e.preventDefault());

            // –í—ã–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', () => selectTool(btn.dataset.tool));
            });

            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Ü–≤–µ—Ç
            document.getElementById('customColor').addEventListener('change', (e) => {
                selectColor(e.target.value);
            });

            // –ò–º–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            document.getElementById('importImage').addEventListener('change', handleImageImport);

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
            document.getElementById('showGrid').addEventListener('change', (e) => {
                if (e.target.checked) {
                    drawGrid();
                } else {
                    redrawCanvas();
                }
            });

            // –ú–∞—Å—à—Ç–∞–±
            document.getElementById('zoomSlider').addEventListener('input', (e) => {
                zoom = parseInt(e.target.value);
                document.getElementById('zoomValue').textContent = zoom + 'x';
                resizeCanvasDisplay();
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            ['startX', 'startY', 'pixelDelay', 'imageName'].forEach(id => {
                document.getElementById(id).addEventListener('input', generateScript);
            });
        }

        function selectTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tool="${tool}"]`).classList.add('active');
            
            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            switch(tool) {
                case 'brush':
                    canvas.style.cursor = 'crosshair';
                    break;
                case 'eraser':
                    canvas.style.cursor = 'grab';
                    break;
                case 'bucket':
                    canvas.style.cursor = 'cell';
                    break;
                case 'picker':
                    canvas.style.cursor = 'copy';
                    break;
                default:
                    canvas.style.cursor = 'crosshair';
            }
        }

        function selectColor(color) {
            if (!color || typeof color !== 'string') {
                color = '#000000';
            }
            
            currentColor = color;
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.classList.remove('selected');
                try {
                    const swatchColor = swatch.style.backgroundColor;
                    if (swatchColor) {
                        const swatchHex = rgbToHex(swatchColor);
                        if (swatchColor === color || swatchHex === color) {
                            swatch.classList.add('selected');
                        }
                    }
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –æ–±—Ä–∞–∑—Ü–æ–≤
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ —Ü–≤–µ—Ç–∞ –æ–±—Ä–∞–∑—Ü–∞:', error);
                }
            });
            document.getElementById('customColor').value = color;
        }

        function getPixelCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvasPixelWidth / rect.width;
            const scaleY = canvasPixelHeight / rect.height;
            
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            
            return { x: Math.max(0, Math.min(x, canvasPixelWidth - 1)), 
                    y: Math.max

(0, Math.min(y, canvasPixelHeight - 1)) };
        }

        function startDrawing(e) {
            isDrawing = true;
            saveState();
            
            const pos = getPixelCoords(ekeyboard_arrow_right
            switch(currentTool) {
                case 'brush':
                case 'eraser':
                    drawPixel(pos.x, pos.y);
                    break;
                case 'bucket':
                    floodFill(pos.x, pos.y);
                    break;
                case 'picker':
                    pickColor(pos.x, pos.y);
                    break;
            }
        }

        function draw(e·ÉÆ
            if (!isDrawing || (currentTool !== 'brush' && currentTool !== 'eraser')) return;
            
            const pos = getPixelCoords(e);
            drawPixel(pos.x, pos.y);
        }

        function stopDrawing() {
            isDrawing = false;
            updateStats();
            generateScript();
        }

        function drawPixel(x, y) {
            const key = `${x},${y}`;
            
            if (currentTool === 'eraser') {
                pixels.delete(key);
            } else {
                pixels.set(key, currentColor);
            }
            
            redrawCanvas();
        }

        function floodFill(startX, startY) {
            const startKey = `${startX},${startY}`;
            const targetColor = pixels.get(startKey) || '#FFFFFF';
            
            if (targetColor === currentColor) return;
            
            const stack = [{x: startX, y: startY}];
            const visited = new Set();
            
            while (stack.length > 0) {
                const {x, y} = stack.pop();
                const key = `${x},${y}`;
                
                if (visited.has(key) || x < 0 || x >= canvasPixelWidth || y < 0 || y >= canvasPixelHeight) {
                    continue;
                }
                
                const currentPixelColor = pixels.get(key) || '#FFFFFF';
                if (currentPixelColor !== targetColor) continue;
                
                visited.add(key);
                pixels.set(key, currentColor);
                
                stack.push({x: x + 1, y: y});
                stack.push({x: x - 1, y: y});
                stack.push({x: x, y: y + 1});
                stack.push({x: x, y: y - 1});
            }
            
            redrawCanvas();
        }

        function pickColor(x, y) {
            const key = `${x},${y}`;
            const color = pixels.get(key);
            if (color) {
                selectColor(color);
            }
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ–Ω
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ø–∏–∫—Å–µ–ª–∏
            const pixelWidth = canvas.width / canvasPixelWidth;
            const pixelHeight = canvas.height / canvasPixelHeight;
            
            pixels.forEach((color, key) => {
                const [x, y] = key.split(',').map(Number);
                ctx.fillStyle = color;
                ctx.fillRect(x * pixelWidth, y * pixelHeight, pixelWidth, pixelHeight);
            });
            
            // –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
            if (document.getElementById('showGrid').checked) {
                drawGrid();
            }
        }

        function drawGrid() {
            const pixelWidth = canvas.width / canvasPixelWidth;
            const pixelHeight = canvas.height / canvasPixelHeight;
            
            ctx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            
            // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let x = 0; x <= canvasPixelWidth; x++) {
                const xPos = x * pixelWidth;
                ctx.moveTo(xPos, 0);
                ctx.lineTo(xPos, canvas.height);
            }
            
            // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for (let y = 0; y <= canvasPixelHeight; y++) {
                const yPos = y * pixelHeight;
                ctx.moveTo(0, yPos);
                ctx.lineTo(canvas.width, yPos);
            }
            
            ctx.stroke();
        }

        function resizeCanvas() {
            const newWidth = parseInt(document.getElementById('canvasWidth').value);
            const newHeight = parseInt(document.getElementById('canvasHeight').value);
            
            canvasPixelWidth = Math.max(5, Math.min(100, newWidth));
            canvasPixelHeight = Math.max(5, Math.min(100, newHeight));
            
            document.getElementById('canvasWidth').value = canvasPixelWidth;
            document.getElementById('canvasHeight').value = canvasPixelHeight;
            
            resizeCanvasDisplay();
            updateStats();
            generateScript();
        }

        function resizeCanvasDisplay() {
            const maxSize = 400;
            const aspectRatio = canvasPixelWidth / canvasPixelHeight;
            
            if (aspectRatio > 1) {
                canvas.width = maxSize * zoom;
                canvas.height = (maxSize / aspectRatio) * zoom;
            } else {
                canvas.width = (maxSize * aspectRatio) * zoom;
                canvas.height = maxSize * zoom;
            }
            
            redrawCanvas();
        }

        function clearCanvas() {
            saveState();
            pixels.clear();
            redrawCanvas();
            updateStats();
            generateScript();
        }

        function saveState() {
            undoStack.push(new Map(pixels));
            redoStack = [];
            if (undoStack.length > 50) undoStack.shift();
        }

        function undoAction() {
            if (undoStack.length > 0) {
                redoStack.push(new Map(pixels));
                pixels = undoStack.pop();
                redrawCanvas();
                updateStats();
                generateScript();
            }
        }

        function redoAction() {
            if (redoStack.length > 0) {
                undoStack.push(new Map(pixels));
                pixels = redoStack.pop();
                redrawCanvas();
                updateStats();
                generateScript();
            }
        }

        function updateStats() {
            const pixelCount = pixels.size;
            const uniqueColors = new Set(pixels.values()).size;
            const delay = parseInt(document.getElementById('pixelDelay').value);
            const estimatedTime = Math.ceil((pixelCount * delay) / 1000);
            
            document.getElementById('pixelCount').textContent = pixelCount;
            document.getElementById('colorCount').textContent = uniqueColors;
            document.getElementById('canvasSize').textContent = `${canvasPixelWidth}x${canvasPixelHeight}`;
            document.getElementById('estimatedTime').textContent = estimatedTime > 60 ? 
                `${Math.floor(estimatedTime / 60)}–º ${estimatedTime % 60}—Å` : `${estimatedTime}—Å`;
        }

        function generateScript() {
            if (pixels.size === 0) {
                document.getElementById('exportOutput').textContent = '–ù–∞—Ä–∏—Å—É–π—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –Ω–∞ —Ö–æ–ª—Å—Ç–µ, —á—Ç–æ–±—ã —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç!';
                return;
            }
            
            const pixelData = Array.from(pixels.entries()).map(([key, color]) => {
                const [x, y] = key.split(',').map(Number);
                return { x, y, color };
            });
            
            const startX = parseInt(document.getElementById('startX').value);
            const startY = parseInt(document.getElementById('startY').value);
            const delay = parseInt(document.getElementById('pixelDelay').value);
            const imageName = document.getElementById('imageName').value.replace(/[^a-zA-Z0-9_]/g, '_') || '–º–æ–π_—Ä–∏—Å—É–Ω–æ–∫';
            
            let output = '';
            
            switch(exportMode) {
                case 'script':
                    output = generateFullScript(pixelData, startX, startY, delay, imageName);
                    break;
                case 'data':
                    output = generateDataOnly(pixelData, imageName);
                    break;
                case 'function':
                    output = generateFunctionOnly(pixelData, imageName);
                    break;
            }
            
            document.getElementById('exportOutput').textContent = output;
        }

        function generateFullScript(pixelData, startX, startY, delay, imageName) {
            return `// –°–∫—Ä–∏–ø—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Ä–µ–¥–∞–∫—Ç–æ—Ä–æ–º –ø–∏–∫—Å–µ–ª—å-–∞—Ä—Ç–∞ - WPlace Bot
// –†–∏—Å—É–Ω–æ–∫: ${imageName} (${canvasPixelWidth}x${canvasPixelHeight})
// –ü–∏–∫—Å–µ–ª–µ–π: ${pixelData.length} | –ó–∞–¥–µ—Ä–∂–∫–∞: ${delay}–º—Å

const ${imageName}Data = [
${pixelData.map(p => `    { x: ${p.x}, y: ${p.y}, color: '${p.color}' }`).join(',\n')}
];

function load${imageName.charAt(0).toUpperCase() + imageName.slice(1)}() {
    if (typeof wplaceBot === 'undefined') {
        console.error('‚ùå WPlace Bot –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –±–æ—Ç.');
        return;
    }
    
    wplaceBot.loadImageFromData(${imageName}Data, '${imageName}');
    wplaceBot.setStartPosition(${startX}, ${startY});
    wplaceBot.setDelay(${delay});
    
    console.log('‚úÖ –†–∏—Å—É–Ω–æ–∫ "${imageName}" –∑–∞–≥—Ä—É–∂–µ–Ω!');
    console.log('üìç –ü–æ–∑–∏—Ü–∏—è: (${startX}, ${startY})');
    console.log('‚è±Ô∏è –ó–∞–¥–µ—Ä–∂–∫–∞: ${delay}–º—Å');
    console.log('üé® –ü–∏–∫—Å–µ–ª–µ–π: ${pixelData.length}');
    console.log('');
    console.log('–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: wplaceBot.start()');
}

// –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞
load${imageName.charAt(0).toUpperCase() + imageName.slice(1)}();

// üé® –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:
// 1. –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ —Å–∞–π—Ç–µ wplace.live
// 2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ WPlace Bot –∑–∞–≥—Ä—É–∂–µ–Ω
// 3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ wplaceBot.start() –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∏—Å–æ–≤–∞–Ω–∏—è`;
        }

        function generateDataOnly(pixelData, imageName) {
            return `// –î–∞–Ω–Ω—ã–µ —Ä–∏—Å—É–Ω–∫–∞: ${imageName}
const ${imageName}Data = [
${pixelData.map(p => `    { x: ${p.x}, y: ${p.y}, color: '${p.color}' }`).join(',\n')}
];

// –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:
// –†–∞–∑–º–µ—Ä: ${canvasPixelWidth}x${canvasPixelHeight}
// –ü–∏–∫—Å–µ–ª–µ–π: ${pixelData.length}
// –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤: ${new Set(pixelData.map(p => p.color)).size}`;
        }

        function generateFunctionOnly(pixelData, imageName) {
            return `// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∏—Å—É–Ω–∫–∞: ${imageName}
function load${imageName.charAt(0).toUpperCase() + imageName.slice(1)}() {
    const pixelData = [
${pixelData.map(p => `        { x: ${p.x}, y: ${p.y}, color: '${p.color}' }`).join(',\n')}
    ];
    
    if (typeof wplaceBot !== 'undefined') {
        wplaceBot.loadImageFromData(pixelData, '${imageName}');
        console.log('‚úÖ –†–∏—Å—É–Ω–æ–∫ "${imageName}" –∑–∞–≥—Ä—É–∂–µ–Ω (${pixelData.length} –ø–∏–∫—Å–µ–ª–µ–π)');
    } else {
        console.error('‚ùå WPlace Bot –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    }
}

// –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
// load${imageName.charAt(0).toUpperCase() + imageName.slice(1)}();
// wplaceBot.setStartPosition(x, y);
// wplaceBot.start();`;
        }

        function showExportTab(mode) {
            exportMode = mode;
            document.querySelectorAll('.export-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            generateScript();
        }

        function copyToClipboard() {
            const text = document.getElementById('exportOutput').textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                btn.style.background = '#48bb78';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#48bb78';
                }, 2000);
            }).catch(err => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
            });
        }

        function handleImageImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    importImageToCanvas(img);
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }

        function importImageToCanvas(img) {
            // –°–æ–∑–¥–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ö–æ–ª—Å—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥ —Ä–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞
            const scale = Math.min(canvasPixelWidth / img.width, canvasPixelHeight / img.height);
            const scaledWidth = Math.floor(img.width * scale);
            const scaledHeight = Math.floor(img.height * scale);
            
            tempCanvas.width = scaledWidth;
            tempCanvas.height = scaledHeight;
            tempCtx.drawImage(img, 0, 0, scaledWidth, scaledHeight);
            
            // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∏–∫—Å–µ–ª–µ–π
            const imageData = tempCtx.getImageData(0, 0, scaledWidth, scaledHeight);
            const data = imageData.data;
            
            saveState();
            pixels.clear();
            
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–∏–∫—Å–µ–ª–∏
            for (let y = 0; y < scaledHeight; y++) {
                for (let x = 0; x < scaledWidth; x++) {
                    const index = (y * scaledWidth + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];
                    const a = data[index + 3];
                    
                    if (a > 128) { // –ù–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π
                        const color = rgbToHex(r, g, b);
                        pixels.set(`${x},${y}`, color);
                    }
                }
            }
            
            redrawCanvas();
            updateStats();
            generateScript();
        }

        function exportPNG() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            tempCanvas.width = canvasPixelWidth * 10; // –ë–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
            tempCanvas.height = canvasPixelHeight * 10;
            
            // –ë–µ–ª—ã–π —Ñ–æ–Ω
            tempCtx.fillStyle = '#FFFFFF';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ø–∏–∫—Å–µ–ª–∏
            pixels.forEach((color, key) => {
                const [x, y] = key.split(',').map(Number);
                tempCtx.fillStyle = color;
                tempCtx.fillRect(x * 10, y * 10, 10, 10);
            });
            
            // –°–∫–∞—á–∞—Ç—å
            const link = document.createElement('a');
            link.download = `${document.getElementById('imageName').value || '–ø–∏–∫—Å–µ–ª—å_–∞—Ä—Ç'}.png`;
            link.href = tempCanvas.toDataURL();
            link.click();
        }

        function rgbToHex(input) {
            // –ï—Å–ª–∏ —É–∂–µ hex-—Ü–≤–µ—Ç, –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
            if (typeof input === 'string' && input.startsWith('#')) {
                return input;
            }
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ RGB, –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
            if (typeof input === 'string' && input.includes('rgb')) {
                const result = input.match(/\d+/g);
                if (!result || result.length < 3) return '#000000';
                
                const r = parseInt(result[0]);
                const g = parseInt(result[1]);
                const b = parseInt(result[2]);
                
                return '#' + [r, g, b].map(x => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
            }
            
            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞
            if (arguments.length === 3) {
                const r = arguments[0];
                const g = arguments[1];
                const b = arguments[2];
                
                if (r === undefined || g === undefined || b === undefined) {
                    return '#000000';
                }
                
                return '#' + [r, g, b].map(x => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
            }
            
            return '#000000';
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', () => {
            // –ü–æ–¥–æ–∂–¥–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
            setTimeout(init, 50);
        });
    </script>
</body>
</html>
